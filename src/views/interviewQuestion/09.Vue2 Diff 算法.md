---
title: Vue2 Diff ç®—æ³•
date: 2022-01-23 14:48:41
permalink: /pages/e1d719/
categories:
  - æ›´å¤š
  - æŠ€æœ¯é¢
tags:
  - Vue
  - é¢è¯•æ€»ç»“
author: 
  name: Ming
  link: https://github.com/Ming-D-W
---

![Vue2 Diff ç®—æ³•](https://photo-album-1314189846.cos.ap-shanghai.myqcloud.com/202303231528140.png)



# Diff ç®—æ³•

## å†™åœ¨å‰é¢

å› ä¸ºä¹‹å‰çœ‹é¢è¯•ç›´æ’­ä¹Ÿç»å¸¸é—®åˆ° Diff ç®—æ³•ï¼Œç„¶åä½œè€…æœ¬äººç”¨ Vue2 æ¯”è¾ƒå¤šï¼Œæ‰€ä»¥æ‰“ç®—ç ”ç©¶ä¸€ä¸‹ Vue2 çš„ Diff ç®—æ³•ï¼Œå…¶å®å¾ˆæ—©å°±æƒ³å­¦çš„ï¼Œä½†æ˜¯å¯èƒ½å› ä¸ºæ„Ÿè§‰ Diff ç®—æ³•æ¯”è¾ƒæ·±å¥¥ï¼Œå°±ä¸€ç›´æ‹–ç€æ²¡å­¦ï¼Œä½†æ˜¯æœ€è¿‘åœ¨å‡†å¤‡é¢è¯•ï¼Œå°±æƒ³ç€è¿Ÿæ—©éƒ½è¦å­¦çš„ï¼Œè¶è¿™ä¸ªæœºä¼šæŠŠ Diff ç®—æ³•ææ‡‚å§ ğŸ§ï¼Œä½œè€…å°±èŠ±äº†ä¸€å¤©çš„æ—¶é—´ç ”ç©¶äº†ä¸€ä¸‹ï¼Œå¯èƒ½æ²¡æœ‰å®Œå…¨ç†è§£ Diff ç®—æ³•çš„ç²¾é«“ï¼Œè¯·å„ä½è§è°…ã€‚

> ğŸ’¡ è¿™ä¸ªå…¶å®ç®—ä½œè€…çš„å­¦ä¹ ç¬”è®°ï¼Œè€Œä¸”ä½œè€…æ°´å¹³æœ‰é™ï¼Œæ”¹æ–‡ç« ä»…ä»£è¡¨ä½œè€…ä¸ªäººè§‚ç‚¹ï¼Œå¦‚æœæœ‰é”™è¯¯å¯ä»¥è¯„è®ºåŒºæŒ‡å‡ºæ¥ï¼Œä¼šä¸æ–­å®Œå–„ï¼›åŒæ—¶æœ¬æ–‡å¾ˆé•¿ï¼Œæ‰€ä»¥è¯·è¯»è€…ä»¬æœ‰è€å¿ƒçš„çœ‹å®Œï¼Œçœ‹å®Œåä½œè€…ç›¸ä¿¡ä½ ä»¬ä¼šå¯¹ Diff ç®—æ³•æœ‰æ›´æ·±çš„äº†è§£ã€‚æœ¬äººè§‰å¾—æœ¬æ–‡æ¯”ç›®å‰ç½‘ä¸Šè®²è§£ Diff ç®—æ³•çš„å¤§éƒ¨åˆ†æ–‡ç« è¦æ›´å¥½ï¼Œå› ä¸ºæœ¬æ–‡ä»é—®é¢˜å‡ºå‘ï¼Œæ•™ä¼šå¤§å®¶å¦‚ä½•æ€è€ƒï¼Œè€Œä¸æ˜¯ç›´æ¥ä»ç­”æ¡ˆå‡ºå‘ï¼Œå°±åƒè¯»ç­”æ¡ˆä¸€æ ·ï¼Œè¿™æ ·æ„Ÿè§‰æ²¡ä»€ä¹ˆæ„æ€ï¼Œæœ¬æ–‡ä¸€æ­¥ä¸€æ­¥çš„å¼•å¯¼å¤§å®¶å»æ„Ÿå— Diff ç®—æ³•çš„ç²¾å¦™ï¼ŒåŒæ—¶æœ€åä¹Ÿåšäº†ä¸€ä¸‹å°å®éªŒï¼Œè®©å¤§å®¶å¯¹ Diff ç®—æ³•æœ‰æ›´åŠ ç›´è§‚çš„æ„Ÿå— ğŸ‰ã€‚

## ä¸ºä»€ä¹ˆè¦ç”¨ Diff ç®—æ³•

### è™šæ‹Ÿ DOM

å› ä¸º Vue2 åº•å±‚æ˜¯ç”¨è™šæ‹Ÿ DOM æ¥è¡¨ç¤ºé¡µé¢ç»“æ„çš„ï¼Œè™šæ‹Ÿ DOMå…¶å®å°±æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¦‚æœæƒ³çŸ¥é“æ€ä¹ˆç”Ÿæˆçš„ï¼Œå…¶å®å¤§æ¦‚æµç¨‹å°±æ˜¯ï¼š

- é¦–å…ˆè§£ææ¨¡æ¿å­—ç¬¦ä¸²ï¼Œä¹Ÿå°±æ˜¯ `.vue` æ–‡ä»¶
- ç„¶åè½¬æ¢æˆ AST è¯­æ³•æ ‘
- æ¥ç€ç”Ÿæˆ render å‡½æ•°
- æœ€åè°ƒç”¨ render å‡½æ•°ï¼Œå°±èƒ½ç”Ÿæˆè™šæ‹Ÿ DOM

### æœ€å°é‡æ›´æ–°

å…¶å®æ¡†æ¶ä¸ºäº†æ€§èƒ½æ‰ä½¿ç”¨çš„è™šæ‹Ÿ DOMï¼Œå› ä¸º js ç”Ÿæˆ DOM ç„¶åå±•ç¤ºé¡µé¢æ˜¯å¾ˆæ¶ˆè€—æ€§èƒ½çš„ï¼Œå¦‚æœæ¯ä¸€æ¬¡çš„æ›´æ–°éƒ½æŠŠæ•´ä¸ªé¡µé¢é‡æ–°ç”Ÿæˆä¸€éé‚£ä½“éªŒè‚¯å®šä¸å¥½ï¼Œæ‰€ä»¥éœ€è¦æ‰¾åˆ°ä¸¤ä¸ªé¡µé¢ä¸­å˜åŒ–çš„åœ°æ–¹ï¼Œç„¶ååªè¦æŠŠå˜åŒ–çš„åœ°æ–¹ç”¨ js æ›´æ–° *(å¯èƒ½æ˜¯å¢åŠ ã€åˆ é™¤æˆ–è€…æ›´æ–°)* ä¸€ä¸‹å°±è¡Œäº†ï¼Œä¹Ÿå°±æ˜¯æœ€å°é‡æ›´æ–°ã€‚ é‚£ä¹ˆæ€ä¹ˆå®ç°æœ€å°é‡æ›´æ–°å‘¢ï¼Ÿé‚£ä¹ˆå°±è¦ç”¨ Diff ç®—æ³•äº†ï¼Œé‚£ä¹ˆ Diff ç®—æ³•å¯¹æ¯”çš„åˆ°åº•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå¯èƒ½è¿™æ˜¯åˆšå­¦ Diff ç®—æ³•æ¯”è¾ƒå®¹æ˜“è¯¯è§£çš„åœ°æ–¹ï¼Œ**å…¶å®æ¯”å¯¹çš„æ˜¯æ–°æ—§è™šæ‹Ÿ DOM**ï¼Œæ‰€ä»¥ Diff ç®—æ³•å°±æ˜¯æ‰¾ä¸åŒï¼Œæ‰¾åˆ°ä¸¤æ¬¡è™šæ‹Ÿ DOM çš„ä¸åŒä¹‹å¤„ï¼Œç„¶åå°†ä¸åŒååº”åˆ°é¡µé¢ä¸Šï¼Œè¿™å°±å®ç°äº†æœ€å°é‡æ›´æ–°ï¼Œå¦‚æœåªæ›´æ–°å˜åŒ–çš„åœ°æ–¹é‚£æ€§èƒ½è‚¯å®šæ›´å¥½ã€‚

## é¡µé¢æ›´æ–°æµç¨‹

å…¶å®è¿™ä¸ªæ¯”è¾ƒéš¾è§£é‡Šï¼Œä½œè€…ä¹Ÿå°±å¤§è‡´è¯´ä¸€ä¸‹ï¼Œå­¦äº† Vue çš„éƒ½çŸ¥é“è¿™ä¸ªæ¡†æ¶çš„ç‰¹ç‚¹ä¹‹ä¸€å°±æœ‰æ•°æ®å“åº”å¼ï¼Œä»€ä¹ˆæ˜¯å“åº”å¼ï¼Œä¹Ÿå°±æ˜¯æ•°æ®æ›´æ–°é¡µé¢ä¹Ÿæ›´æ–°ï¼Œé‚£ä¹ˆé¡µé¢æ˜¯æ€ä¹ˆçŸ¥é“è‡ªå·±è¦æ›´æ–°äº†å‘¢ï¼Ÿå…¶å®è¿™å°±æ˜¯è¿™ä¸ªæ¡†æ¶æ¯”è¾ƒé«˜æ˜çš„åœ°æ–¹äº†ï¼Œå¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š

- ä¹‹å‰ä¹Ÿè¯´äº†ä¼šè¿è¡Œ render å‡½æ•°ï¼Œé‚£ä¹ˆè¿è¡Œ render å‡½æ•°çš„æ—¶å€™ä¼šè¢«æ•°æ®åŠ«æŒï¼Œä¹Ÿå°±æ˜¯è¿›å…¥ `Object.defineProperty` çš„ `get`ï¼Œé‚£ä¹ˆåœ¨è¿™é‡Œæ”¶é›†ä¾èµ–ï¼Œé‚£ä¹ˆæ˜¯è°æ”¶é›†ä¾èµ–å‘¢ï¼Ÿæ˜¯æ¯ä¸ªç»„ä»¶ï¼Œæ¯ä¸ªç»„ä»¶å°±æ˜¯ä¸€ä¸ª Watcherï¼Œä¼šè®°å½•è¿™ä¸ªç»„ä»¶å†…çš„æ‰€æœ‰å˜é‡ *(ä¹Ÿå°±æ˜¯ä¾èµ–)*ï¼Œå½“ç„¶æ¯ä¸ªä¾èµ– *(Dep)* ä¹Ÿä¼šæ”¶é›†è‡ªå·±æ‰€åœ¨ç»„ä»¶çš„ Watcherï¼›
- ç„¶åå½“é¡µé¢ä¸­çš„æ•°æ®å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆå°±ä¼šå‡ºå‘ `Object.defineProperty` çš„ `set`ï¼Œåœ¨è¿™ä¸ªå‡½æ•°é‡Œé¢æ•°æ®å°±ä¼šé€šçŸ¥æ¯ä¸ª Watcher æ›´æ–°é¡µé¢ï¼Œç„¶åæ¯ä¸ªé¡µé¢å°±ä¼šè°ƒç”¨æ›´æ–°æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯ `patch`ï¼›
- æ¥ç€ï¼Œå°±è¦æ‰¾åˆ°ä¸¤ä¸ªé¡µé¢ä¹‹é—´çš„å˜åŒ–é‡ï¼Œé‚£ä¹ˆå°±è¦ç”¨åˆ° Diff ç®—æ³•äº†
- æœ€åæ‰¾åˆ°å˜åŒ–é‡åå°±å¯ä»¥è¿›è¡Œæ›´æ–°é¡µé¢äº†

> å…¶å®æ˜¯è¾¹æ‰¾è¾¹æ›´æ–°çš„ï¼Œä¸ºäº†è®©å¤§å®¶ç†è§£å®¹æ˜“å°±å°†è¿™ä¸¤ä¸ªéƒ¨åˆ†åˆ†å¼€äº†

## Diff ç®—æ³•ç®€å•ä»‹ç»

é¢è¯•é—®åˆ° Diff ç®—æ³•æ˜¯ä»€ä¹ˆï¼Œå¤§å®¶è‚¯å®šä¼šè¯´ä¸¤å¥ï¼Œæ¯”å¦‚ `å¤´å¤´ã€å°¾å°¾ã€å°¾å¤´ã€å¤´å°¾`ã€`æ·±åº¦ä¼˜å…ˆéå†(dfs)`ã€`åŒå±‚æ¯”è¾ƒ` ç±»ä¼¼è¿™äº›è¯è¯­ï¼Œè™½ç„¶èƒ½è¯´ä¸€ä¸¤å¥å…¶å®ä¹Ÿæ˜¯æµ…å°è¾„æ­¢ã€‚ å…¶å®ä½œè€…çœ‹äº† CSDN ä¸Šå‘çš„å…³äº Diff ç®—æ³•çš„æ–‡ç« ï¼Œå°±æ˜¯é˜…è¯»é‡å¾ˆé«˜çš„æ–‡ç« ï¼Œä½œè€…è§‰å¾—ä»–ä¹Ÿæ²¡è®²æ˜ç™½ï¼Œå¯èƒ½ä»–è‡ªå·±æ²¡æ˜ç™½ï¼Œæˆ–è€…è‡ªå·±æ˜ç™½äº†ä½†æ˜¯æ²¡è®²æ¸…æ¥šï¼Œé‚£ä¹ˆä½œè€…ä¼šç”¨è‡ªå·±çš„æ„Ÿæ‚Ÿå’Œå¤§å®¶åˆ†äº«ä¸€ä¸‹ã€‚

### Diff ç®—æ³•çš„å‰æ

ä¸ºäº†è®©å¤§å®¶èƒ½å¤Ÿäº†è§£æ¸…æ¥šï¼Œè¿™é‡Œå…ˆè¯´æ˜ä¸€ä¸‹å‡½æ•°è°ƒç”¨æµç¨‹ï¼š

- patch
- patchVnode
- updateChildren

Diff ç®—æ³•çš„ `å‰æ` è¿™ä¸ªæ˜¯å¾ˆé‡è¦çš„ï¼Œå¯èƒ½å¤§å®¶ä¼šé—®ä»€ä¹ˆæ˜¯å‰æï¼Ÿä¸å°±æ˜¯ä¹‹å‰è¯´çš„é‚£äº›æ¯”è¾ƒå˜›ï¼Ÿè¯´çš„æ²¡é”™ä½†ä¹Ÿä¸å¯¹ï¼Œå› ä¸º Diff ç®—æ³•åˆ°è¾¾ä¹‹å‰è¯´çš„ `å¤´å¤´ã€å°¾å°¾ã€å°¾å¤´ã€å¤´å°¾` è¿™ä¸€æ­¥çš„å‰æå°±æ˜¯ä¸¤æ¬¡å¯¹æ¯”çš„èŠ‚ç‚¹æ˜¯ `ç›¸åŒçš„`ï¼Œè¿™é‡Œçš„ç›¸åŒä¸æ˜¯å¤§å®¶æƒ³çš„å®Œå…¨ç›¸åŒï¼Œåªæ˜¯ç¬¦åˆæŸäº›æ¡ä»¶å°±æ˜¯ç›¸åŒäº†ï¼Œä¸ºäº†ç®€åŒ–è¯´æ˜ï¼Œæ–‡ç« å°±åªè€ƒè™‘ä¸€ä¸ªæ ‡ç­¾åªåŒ…å« `key` å’Œ `æ ‡ç­¾å(tag)`ï¼Œé‚£ä¹ˆä¹‹å‰è¯´çš„ç›¸åŒå°±æ˜¯ `key ç›¸åŒä»¥åŠ tag ç›¸åŒ`ï¼Œä¸ºäº†è¯æ˜ä½œè€…çš„è¯´æ³•æ˜¯æœ‰ç‚¹æ­£ç¡®çš„ï¼Œé‚£ä¹ˆè¿™é‡Œä¹Ÿè´´ä¸Šæºç ï¼š

```js
// https://github.com/vuejs/vue/blob/main/src/core/vdom/patch.ts
// 36è¡Œ
function sameVnode(a, b) {
  return (
    a.key === b.key &&
    a.asyncFactory === b.asyncFactory &&
    ((a.tag === b.tag &&
      a.isComment === b.isComment &&
      isDef(a.data) === isDef(b.data) &&
      sameInputType(a, b)) ||
      (isTrue(a.isAsyncPlaceholder) && isUndef(b.asyncFactory.error)))
  )
}
```

å¦‚æœæ€•ä¹±äº†ï¼Œä¸‹é¢çš„å¯ä»¥çœç•¥ä¸çœ‹ä¹Ÿæ²¡äº‹ä¸å½±å“æ•´ä½“äº†è§£ï¼Œä¸‹é¢åªæ˜¯ä¸ºäº†è€ƒè™‘æ‰€æœ‰æƒ…å†µæ‰åŠ çš„ä¸€ä¸ªåˆ¤æ–­ï¼š é‚£ä¹ˆå¦‚æœä¸¤ä¸ªè™šæ‹Ÿ DOM ä¸ç›¸åŒå…¶å®å°±ä¸ç”¨ç»§ç»­æ¯”è¾ƒäº†ï¼Œè€Œä¸”å¦‚æœç›¸åŒä¹Ÿä¸ç”¨æ¯”è¾ƒäº†ï¼Œè¿™é‡Œçš„ç›¸åŒæ˜¯çœŸçš„å®Œå…¨ç›¸åŒï¼Œä¹Ÿå°±æ˜¯ä¸¤ä¸ªè™šæ‹Ÿ DOM çš„åœ°å€æ˜¯ä¸€æ ·çš„ï¼Œé‚£ä¹ˆä¹Ÿè´´ä¸Šæºç ï¼š

```js
function patchVnode(......) {
  if (oldVnode === vnode) {
    return
  }
  ......
}
```

åˆ°ç›®å‰ä¸ºæ­¢å¤§å®¶å¯èƒ½ä¼šæ¯”è¾ƒä¹±ï¼Œç°åœ¨æ€»ç»“ä¸€ä¸‹ï¼š

- åœ¨ `patch` å‡½æ•°é‡Œæ¯”è¾ƒçš„æ˜¯æ–°è€è™šæ‹Ÿ DOM æ˜¯å¦æ˜¯ `key ç›¸åŒä»¥åŠ tag ç›¸åŒ`ï¼Œå¦‚æœä¸ç›¸åŒé‚£ä¹ˆå°±ç›´æ¥æ›¿æ¢ï¼Œå¦‚æœç›¸åŒç”¨ `patchVnode`

è¯´äº†è¿™ä¹ˆå¤šï¼Œå…¶å®ä½œè€…ä¹Ÿå°±æƒ³è¡¨è¾¾ä¸€ä¸ªè§‚ç‚¹ï¼Œå°±æ˜¯åªæœ‰å½“ä¸¤æ¬¡æ¯”è¾ƒçš„è™šæ‹Ÿ DOM æ˜¯ `ç›¸åŒçš„` æ‰ä¼šè€ƒè™‘ Diff ç®—æ³•ï¼Œå¦‚æœä¸ç¬¦åˆé‚£ç›´æ¥æŠŠåŸæ¥çš„åˆ é™¤ï¼Œæ›¿æ¢æ–°çš„ DOM å°±è¡Œäº†ã€‚

## patchVnode å‡½æ•°

è¿™ä¸ªå‡½æ•°é‡Œçš„æ‰æ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„ Diff ç®—æ³•ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥ä¼šç»“åˆæºç å‘å¤§å®¶ä»‹ç»ä¸€ä¸‹ã€‚

> æºç ä¸­æ ¸å¿ƒä»£ç åœ¨ [patch.ts](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fvuejs%2Fvue%2Fblob%2Fa9ca2d85193e435e668ba25ace481bfb176b0c6e%2Fsrc%2Fcore%2Fvdom%2Fpatch.ts%23L584) çš„ 638 è¡Œè‡³ 655 è¡Œã€‚

å…¶å®ï¼Œç›®å‰ä»‹ç» patchVnode çš„éƒ½æ˜¯ç›´æ¥å¯¹ç€æºç æ¥ä»‹ç»çš„ï¼Œä½†æ˜¯å¤§å®¶å¯èƒ½ä¸æ¸…æ¥šä¸ºå•¥è¦è¿™ä¹ˆåˆ†ç±»ï¼Œé‚£ä¹ˆä½œè€…åœ¨è¿™é‡Œå°±è®©å¤§å®¶æ˜ç™½ä¸ºä»€ä¹ˆè¿™ä¹ˆåˆ†ç±»ï¼Œé¦–å…ˆåœ¨è¿™é‡Œè¯´ä¸€ä¸ªç»“è®ºï¼š

- å°±æ˜¯ `text` å±æ€§å’Œ `children` å±æ€§ä¸å¯èƒ½åŒæ—¶å­˜åœ¨ï¼Œè¿™ä¸ªéœ€è¦å¤§å®¶çœ‹æ¨¡æ¿è§£ææºç éƒ¨åˆ†

é‚£ä¹ˆåœ¨å¯¹æ¯”æ–°æ—§èŠ‚ç‚¹çš„æƒ…å†µä¸‹ï¼Œä¸»è¦æ¯”è¾ƒçš„å°±æ˜¯æ˜¯å¦å­˜åœ¨ `text` å’Œ `children` çš„æƒ…å†µï¼Œé‚£ä¹ˆä¼šæœ‰å¦‚ä¸‹ä¹ç§æƒ…å†µ

| æƒ…å†µ | è€èŠ‚ç‚¹ text | è€èŠ‚ç‚¹ children | æ–°èŠ‚ç‚¹ text | æ–°èŠ‚ç‚¹ children |
| ---- | ----------- | --------------- | ----------- | --------------- |
| 1    | â           | â               | â           | â               |
| 2    | â           | âœ…               | â           | â               |
| 3    | âœ…           | â               | â           | â               |
| 4    | â           | â               | â           | âœ…               |
| 5    | â           | âœ…               | â           | âœ…               |
| 6    | âœ…           | â               | â           | âœ…               |
| 7    | â           | â               | âœ…           | â               |
| 8    | â           | âœ…               | âœ…           | â               |
| 9    | âœ…           | â               | âœ…           | â               |

æŒ‰ç…§ä¸Šé¢çš„è¡¨æ ¼ï¼Œå› ä¸ºå¦‚æœæ–°èŠ‚ç‚¹æœ‰æ–‡æœ¬èŠ‚ç‚¹ï¼Œå…¶å®è€èŠ‚ç‚¹ä¸ç®¡æ˜¯ä»€ä¹ˆéƒ½ä¼šè¢«æ›¿æ¢æ‰ï¼Œé‚£ä¹ˆå°±å¯ä»¥æŒ‰ç…§ `æ–°èŠ‚ç‚¹ text` æ˜¯å¦å­˜åœ¨æ¥åˆ†ç±»ï¼Œå…¶å® Vue æºç ä¹Ÿæ˜¯è¿™ä¹ˆæ¥åˆ†ç±»çš„ï¼š

```js
if (isUndef(vnode.text)) {
  // æ–°è™šæ‹Ÿ DOM æœ‰å­èŠ‚ç‚¹
} else if (oldVnode.text !== vnode.text) {
  // å¦‚æœæ–°è™šæ‹Ÿ DOM æ˜¯æ–‡æœ¬èŠ‚ç‚¹ï¼Œç›´æ¥ç”¨ textContent æ›¿æ¢æ‰
  nodeOps.setTextContent(elm, vnode.text)
}
å¤åˆ¶ä»£ç 
```

é‚£ä¹ˆå¦‚æœæœ‰å­èŠ‚ç‚¹çš„è¯ï¼Œé‚£åº”è¯¥æ€ä¹ˆåˆ†ç±»å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥æŒ‰ç…§æ¯ç§æƒ…å†µéœ€è¦åšä»€ä¹ˆæ¥è¿›è¡Œåˆ†ç±»ï¼Œæ¯”å¦‚è¯´ï¼š

- ç¬¬ä¸€ç§æƒ…å†µï¼Œæˆ‘ä»¬å•¥éƒ½ä¸ç”¨åšï¼Œå› æ­¤ä¹Ÿå¯ä»¥ä¸ç”¨è€ƒè™‘
- ç¬¬äºŒç§æƒ…å†µï¼Œæˆ‘ä»¬åº”è¯¥æŠŠåŸæ¥ DOM çš„ `textContent` è®¾ç½®ä¸º `''`
- ç¬¬ä¸‰ç§æƒ…å†µï¼Œæˆ‘ä»¬ä¹Ÿåº”è¯¥æŠŠåŸæ¥ DOM çš„ `textContent` è®¾ç½®ä¸º `''`
- ç¬¬å››ç§æƒ…å†µï¼Œæˆ‘ä»¬åº”è¯¥åŠ å…¥æ–°çš„å­èŠ‚ç‚¹
- ç¬¬äº”ç§æƒ…å†µï¼Œè¿™ä¸ªæƒ…å†µæ¯”è¾ƒå¤æ‚ï¼Œéœ€è¦å¯¹æ¯”æ–°è€å­èŠ‚ç‚¹çš„ä¸åŒ
- ç¬¬å…­ç§æƒ…å†µï¼Œæˆ‘ä»¬åº”è¯¥æŠŠåŸæ¥çš„ `textContent` è®¾ç½®ä¸º `''` åå†åŠ å…¥æ–°çš„å­èŠ‚ç‚¹

é‚£ä¹ˆé€šè¿‡ä»¥ä¸Šå…­ç§æƒ…å†µ *(æ–°è™šæ‹Ÿ DOM ä¸å«æœ‰ textï¼Œä¹Ÿå°±æ˜¯ä¸æ˜¯æ–‡æœ¬èŠ‚ç‚¹çš„æƒ…å†µ)*ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“åœ°è¿›è¡Œå½’ç±»ï¼š

- åˆ†ç±» 1ï¸âƒ£ï¼š `ç¬¬äºŒç§æƒ…å†µ` å’Œ `ç¬¬ä¸‰ç§æƒ…å†µ`ã€‚è¿›è¡Œçš„æ˜¯æ“ä½œæ˜¯ï¼š**æŠŠåŸæ¥ DOM çš„ `textContent` è®¾ç½®ä¸º `''`**
- åˆ†ç±» 2ï¸âƒ£ï¼š `ç¬¬å››ç§æƒ…å†µ` å’Œ `ç¬¬å…­ç§æƒ…å†µ`ã€‚è¿›è¡Œçš„æ˜¯æ“ä½œæ˜¯ï¼š**å¦‚æœè€è™šæ‹Ÿ DOM æœ‰ `text`ï¼Œå°±ç½®ç©ºï¼Œç„¶ååŠ å…¥æ–°çš„å­èŠ‚ç‚¹**
- åˆ†ç±» 3ï¸âƒ£ï¼š`ç¬¬äº”ç§æƒ…å†µ`ã€‚è¿›è¡Œçš„æ˜¯æ“ä½œæ˜¯ï¼š**éœ€è¦è¿›è¡Œç²¾ç»†æ¯”è¾ƒï¼Œå³å¯¹æ¯”æ–°è€å­èŠ‚ç‚¹çš„ä¸åŒ**

å…¶å®æºç ä¹Ÿæ˜¯è¿™ä¹ˆæ¥è¿›è¡Œåˆ†ç±»çš„ï¼Œè€Œä¸”ä¹‹å‰è¯´çš„ `åŒå±‚æ¯”è¾ƒ` ä¹Ÿå°±å¾—å‡ºæ¥äº†ï¼Œå› ä¸ºæ¯æ¬¡æ¯”è¾ƒéƒ½æ˜¯æ¯”è¾ƒçš„åŒä¸€ä¸ªçˆ¶èŠ‚ç‚¹æ¯ä¸€ä¸ªå­å…ƒç´  *(è¿™é‡Œçš„å­å…ƒç´ åŒ…æ‹¬æ–‡æœ¬èŠ‚ç‚¹å’Œå­èŠ‚ç‚¹)* æ˜¯å¦ç›¸åŒï¼Œè€Œ `æ·±åº¦ä¼˜å…ˆéå†(dfs)` æ˜¯å› ä¸ºæ¯æ¬¡æ¯”è¾ƒä¸­ï¼Œå¦‚æœè¯¥èŠ‚ç‚¹æœ‰å­èŠ‚ç‚¹ *(è¿™é‡Œçš„å­èŠ‚ç‚¹æŒ‡çš„æ˜¯æœ‰ children å±æ€§ï¼Œè€Œä¸åŒ…æ‹¬æ–‡æœ¬èŠ‚ç‚¹)* çš„è¯éœ€è¦è¿›è¡Œé€’å½’éå†ï¼ŒçŸ¥é“æœ€ååˆ°æ–‡æœ¬èŠ‚ç‚¹ç»“æŸã€‚

> â­•ï¸ è¿™é‡Œéœ€è¦ææ¸…æ¥šå­èŠ‚ç‚¹å’Œå­å…ƒç´ çš„åŒºåˆ«å’Œè”ç³»

ç„¶åæˆ‘ä»¬æ¥çœ‹çœ‹æºç æ˜¯æ€ä¹ˆå†™å§ï¼Œåªçœ‹æ–°è™šæ‹Ÿ DOM ä¸å«æœ‰ textï¼Œä¹Ÿå°±æ˜¯ä¸æ˜¯æ–‡æœ¬èŠ‚ç‚¹çš„æƒ…å†µï¼š

```js
if (isUndef(vnode.text)) {
  if (isDef(oldCh) && isDef(ch)) {
    if (oldCh !== ch)
      // é€’å½’å¤„ç†ï¼Œç²¾ç»†æ¯”è¾ƒ
      // å¯¹åº”åˆ†ç±» 3ï¸âƒ£
      updateChildren(elm, oldCh, ch, insertedVnodeQueue, removeOnly)
  } else if (isDef(ch)) {
    if (__DEV__) {
      checkDuplicateKeys(ch) // å¯ä»¥å¿½ç•¥ä¸çœ‹
    }
    // å¯¹åº”åˆ†ç±» 2ï¸âƒ£
    if (isDef(oldVnode.text)) nodeOps.setTextContent(elm, '')
    addVnodes(elm, null, ch, 0, ch.length - 1, insertedVnodeQueue)
  } else if (isDef(oldCh)) {
  	// å¯¹åº”åˆ†ç±» 1ï¸âƒ£
    removeVnodes(oldCh, 0, oldCh.length - 1)
  } else if (isDef(oldVnode.text)) {
  	// å¯¹åº”åˆ†ç±» 1ï¸âƒ£
    nodeOps.setTextContent(elm, '')
  }
}
```

â“æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æºç æŠŠåˆ†ç±» 1ï¸âƒ£ æ‹†å¼€æ¥äº†ï¼Œè¿™æ˜¯å› ä¸ºå¦‚æœè€è™šæ‹Ÿ DOM æœ‰å­èŠ‚ï¼Œé‚£ä¹ˆå¯èƒ½ç»‘å®šäº†ä¸€äº›å‡½æ•°ï¼Œéœ€è¦è¿›è¡Œè§£ç»‘ç­‰ä¸€ç³»åˆ—æ“ä½œï¼Œä½œè€…ä¹Ÿæ²¡è‡ªä¿¡çœ‹ï¼Œå¤§è‡´ç„äº†ä¸€çœ¼ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬è¦æ±‚ä¸é«˜ï¼Œå¦‚æœåªæ˜¯æƒ³è‡ªå·±æ‰‹åŠ¨å®ç° Diff ç®—æ³•ï¼Œé‚£ä¹ˆæ²¡æœ‰æ‹†å¼€çš„å¿…è¦ã€‚

ä½œè€…è§‰å¾—è¿™ä¹ˆè®²å¯èƒ½æ¯”ç½‘ä¸Šå…¶ä»–ä»‹ç» Diff ç®—æ³•çš„è¦å¥½ï¼Œå…¶ä»–çš„å¯èƒ½ç›´æ¥ç»™ä½ è¯´æºç æ˜¯æ€ä¹ˆå†™çš„ï¼Œå¯èƒ½æ²¡æœ‰è¯´æ˜ç™½ä¸ºå•¥è¿™ä¹ˆå†™ï¼Œä½†æ˜¯é€šè¿‡ä¹‹å‰è¿™ä¹ˆåˆ†æè®²è§£åå¯èƒ½ä½ å¯¹ä¸ºä»€ä¹ˆè¿™ä¹ˆå†™ä¼šæœ‰æ›´æ·±çš„ç†è§£å’Œå¸®åŠ©å§ã€‚

## updateChildren å‡½æ•°

> åŒå±‚æ¯”è¾ƒ

å› ä¸ºå½“éƒ½å«æœ‰å­èŠ‚ç‚¹ï¼Œå³éƒ½åŒ…å« children å±æ€§åï¼Œéœ€è¦ç²¾ç»†æ¯”è¾ƒä¸åŒï¼Œä¸èƒ½åƒä¹‹å‰é‚£äº›æƒ…å†µä¸€æ ·è¿›è¡Œç®€å•å¤„ç†å°±å¯ä»¥äº† é‚£ä¹ˆè¿™ä¸ªå‡½æ•°ä¸­å°±ä¼šä»‹ç»å¤§å®¶ç»å¸¸è¯´çš„ `å¤´å¤´ã€å°¾å°¾ã€å°¾å¤´ã€å¤´å°¾` æ¯”è¾ƒäº†ï¼Œå…¶å®è¿™ä¸æ˜¯ Vue æå‡ºæ¥çš„ï¼Œæ˜¯å¾ˆæ—©å°±æå‡ºæ¥çš„ç®—æ³•ï¼Œå°±ä¸€ç›´æ²¿ç”¨è‡³ä»Šï¼Œå¤§å®¶å¯ä»¥å‚è€ƒ[ã€snabbdom åº“ã€‘](https://link.juejin.cn/?target=https%3A%2F%2Fgithub.com%2Fsnabbdom%2Fsnabbdom%2Ftree%2F794f6c210d25d6b095154b559828292359e1d298)

ğŸŒŸ åœ¨è¿™ä¹‹å‰æˆ‘ä»¬è¦å®šä¹‰å››ä¸ªæŒ‡é’ˆ `newStartIdx`ã€`newEndIdx`ã€`oldStartIdx` å’Œ `oldEndIdx`ï¼Œåˆ†åˆ«æŒ‡å‘ `æ–°å¤´èŠ‚ç‚¹`ã€`æ–°å°¾èŠ‚ç‚¹`ã€`æ—§å¤´èŠ‚ç‚¹` ä¸ `æ—§å°¾èŠ‚ç‚¹`

å¾ªç¯æ¡ä»¶å¦‚ä¸‹ï¼š

```js
while(oldStartIdx <= oldEndIdx && newStartIdx <= newEndIdx) {
  ......
}
```

å…¶å®è¿™ä¸ªæ¯”è¾ƒä¹Ÿå°±æ˜¯æŒ‰äººç±»çš„ä¹ æƒ¯æ¥è¿›è¡Œæ¯”è¾ƒçš„ï¼Œæ¯”è¾ƒé¡ºåºå¦‚ä¸‹ ï¼š

- 1ï¸âƒ£ `æ–°å¤´èŠ‚ç‚¹`ä¸`æ—§å¤´èŠ‚ç‚¹`ï¼š`++newStartIdx` å’Œ `++oldStartIdx`

- 2ï¸âƒ£ `æ–°å°¾èŠ‚ç‚¹`ä¸`æ—§å°¾èŠ‚ç‚¹`ï¼š`--newEndIdx` å’Œ `--oldEndIdx`

- 3ï¸âƒ£ `æ–°å°¾èŠ‚ç‚¹`ä¸`æ—§å¤´èŠ‚ç‚¹`ï¼šéœ€è¦å°† `æ—§å¤´èŠ‚ç‚¹` ç§»åŠ¨åˆ° `æ—§å°¾èŠ‚ç‚¹ä¹‹å‰`ï¼Œä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšï¼Œè®²èµ·æ¥æ¯”è¾ƒå¤æ‚ï¼Œè®°ä½å°±å¥½ï¼Œç„¶å `--newEndIdx` å’Œ `++oldStartIdx`

- 4ï¸âƒ£ `æ–°å¤´èŠ‚ç‚¹`ä¸`æ—§å°¾èŠ‚ç‚¹`ï¼šéœ€è¦å°† `æ—§å°¾èŠ‚ç‚¹` ç§»åŠ¨åˆ° `æ—§å¤´èŠ‚ç‚¹ä¹‹å‰`ï¼Œä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšï¼Œè®²èµ·æ¥æ¯”è¾ƒå¤æ‚ï¼Œè®°ä½å°±å¥½ï¼Œç„¶å `++newStartIdx` å’Œ `--oldEndIdx`

- 5ï¸âƒ£ å¦‚æœéƒ½æ²¡æœ‰åŒ¹é…çš„è¯ï¼Œå°±æŠŠ`æ–°å¤´èŠ‚ç‚¹`åœ¨æ—§èŠ‚ç‚¹åˆ—è¡¨(ä¹Ÿå°±æ˜¯ children å±æ€§çš„å€¼) ä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼ŒæŸ¥æ‰¾æ–¹å¼æŒ‰ç…§å¦‚ä¸‹ï¼š
  - å¦‚æœæœ‰ `key` å°±æŠŠ `key` åœ¨ `oldKeyToIdx` è¿›è¡ŒåŒ¹é…ï¼Œ`oldKeyToIdx` æ ¹æ®æ—§èŠ‚ç‚¹åˆ—è¡¨ä¸­å…ƒç´ çš„ `key` ç”Ÿæˆå¯¹åº”çš„ä¸‹æ ‡
  - å¦‚æœæ²¡æœ‰ï¼Œå°±æŒ‰é¡ºåºéå†æ—§èŠ‚ç‚¹åˆ—è¡¨æ‰¾åˆ°è¯¥èŠ‚ç‚¹æ‰€åœ¨çš„ä¸‹æ ‡
  - å¦‚æœåœ¨æ—§èŠ‚ç‚¹åˆ—è¡¨æ˜¯å¦æ‰¾åˆ°ä¹Ÿåˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š
    - æ‰¾åˆ°äº†ï¼Œé‚£ä¹ˆåªè¦å°† `æ–°å¤´èŠ‚ç‚¹` æ·»åŠ åˆ° `æ—§å¤´èŠ‚ç‚¹` ä¹‹å‰å³å¯
    - æ²¡æ‰¾åˆ°ï¼Œé‚£ä¹ˆéœ€è¦åˆ›å»ºæ–°çš„å…ƒç´ ç„¶åæ·»åŠ åˆ° `æ—§å¤´èŠ‚ç‚¹` ä¹‹å‰
    - ç„¶åæŠŠè¿™ä¸ªèŠ‚ç‚¹è®¾ç½®ä¸º `undefined`

æ ¹æ®å¾ªç¯æ¡ä»¶æˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸¤ç§å‰©ä½™æƒ…å†µï¼Œå¦‚ä¸‹ï¼š

- 6ï¸âƒ£ å¦‚æœ `oldStartIdx > oldEndIdx` è¯´æ˜è€èŠ‚ç‚¹å…ˆéå†å®Œæˆï¼Œé‚£ä¹ˆæ–°èŠ‚ç‚¹æ¯”è€èŠ‚ç‚¹å¤šï¼Œå°±è¦æŠŠ `newStartIdx` ä¸ `newEndIdx` ä¹‹é—´çš„å…ƒç´ æ·»åŠ 
- 7ï¸âƒ£ å¦‚æœ `newStartIdx > newEndIdx` è¯´æ˜æ–°èŠ‚ç‚¹å…ˆéå†å®Œæˆï¼Œé‚£ä¹ˆè€èŠ‚ç‚¹æ¯”æ–°èŠ‚ç‚¹å¤šï¼Œå°±è¦æŠŠ `oldStartIdx` ä¸ `oldEndIdx` ä¹‹é—´çš„å…ƒç´ åˆ é™¤

å…¶å®æˆ‘ä»¬ä¸Šé¢è¿˜æ²¡æœ‰è€ƒè™‘å¦‚æœèŠ‚ç‚¹ä¸º `undefined` çš„æƒ…å†µï¼Œå› ä¸ºåœ¨ä¸Šé¢ä¹Ÿæåˆ°è¿‡ï¼Œå¦‚æœå››ç§éƒ½ä¸åŒ¹é…åä¼šå°†è¯¥èŠ‚ç‚¹ç½®ä¸º `undefined`ï¼Œä¹Ÿåªæœ‰æ—§èŠ‚ç‚¹åˆ—è¡¨ä¸­æ‰æœ‰ï¼Œå› æ­¤è¦åœ¨å¼€å¤´è€ƒè™‘è¿™ä¸¤ç§æƒ…å†µï¼š

- 8ï¸âƒ£ å½“ `oldStartVnode` ä¸º `undefined`ï¼š`++oldStartIdx`
- 9ï¸âƒ£ å½“ `oldEndVnode` ä¸º `undefined`ï¼š`--oldEndIdx`

é‚£ä¹ˆæˆ‘ä»¬æ¥çœ‹æºç æ€ä¹ˆå†™çš„å§ï¼Œå…¶ä¸­ç”¨åˆ°çš„å‡½æ•°å¯ä»¥æŸ¥çœ‹**æºç é™„å½•**ï¼š

```js
// https://github.com/vuejs/vue/blob/main/src/core/vdom/patch.ts
// 439 è¡Œè‡³ 556 è¡Œ
while (oldStartIdx <= oldEndIdx && newStartIdx <= newEndIdx) {
  if (isUndef(oldStartVnode)) {
  	// æƒ…å†µ 8ï¸âƒ£
    oldStartVnode = oldCh[++oldStartIdx] // Vnode has been moved left
  } else if (isUndef(oldEndVnode)) {
  	// æƒ…å†µ 9ï¸âƒ£
    oldEndVnode = oldCh[--oldEndIdx]
  } else if (sameVnode(oldStartVnode, newStartVnode)) {
  	// æƒ…å†µ 1ï¸âƒ£
    patchVnode(...)
    oldStartVnode = oldCh[++oldStartIdx]
    newStartVnode = newCh[++newStartIdx]
  } else if (sameVnode(oldEndVnode, newEndVnode)) {
  	// æƒ…å†µ 2ï¸âƒ£
    patchVnode(...)
    oldEndVnode = oldCh[--oldEndIdx]
    newEndVnode = newCh[--newEndIdx]
  } else if (sameVnode(oldStartVnode, newEndVnode)) {
    // Vnode moved right
    // æƒ…å†µ 3ï¸âƒ£
    patchVnode(...)
    canMove &&
      nodeOps.insertBefore(
        parentElm,
        oldStartVnode.elm,
        nodeOps.nextSibling(oldEndVnode.elm)
      )
    oldStartVnode = oldCh[++oldStartIdx]
    newEndVnode = newCh[--newEndIdx]
  } else if (sameVnode(oldEndVnode, newStartVnode)) {
    // Vnode moved left
    // æƒ…å†µ 4ï¸âƒ£
    patchVnode(...)
    canMove &&
      nodeOps.insertBefore(parentElm, oldEndVnode.elm, oldStartVnode.elm)
    oldEndVnode = oldCh[--oldEndIdx]
    newStartVnode = newCh[++newStartIdx]
  } else {
  	// æƒ…å†µ 5ï¸âƒ£
    if (isUndef(oldKeyToIdx)) // åˆ›å»º key -> index çš„ Map
      oldKeyToIdx = createKeyToOldIdx(oldCh, oldStartIdx, oldEndIdx) 
    // æ‰¾åˆ° æ–°å¤´èŠ‚ç‚¹ çš„ä¸‹æ ‡
    idxInOld = isDef(newStartVnode.key)
      ? oldKeyToIdx[newStartVnode.key]
      : findIdxInOld(newStartVnode, oldCh, oldStartIdx, oldEndIdx)
    if (isUndef(idxInOld)) {
      // New element
      // å¦‚æœæ²¡æ‰¾åˆ°
      createElm(...)
    } else {
      // å¦‚æœæ‰¾åˆ°äº†
      vnodeToMove = oldCh[idxInOld]
      if (sameVnode(vnodeToMove, newStartVnode)) {
        patchVnode(...)
        oldCh[idxInOld] = undefined
        canMove &&
          nodeOps.insertBefore(
            parentElm,
            vnodeToMove.elm,
            oldStartVnode.elm
          )
      } else {
        // same key but different element. treat as new element
        createElm(...)
      }
    }
    newStartVnode = newCh[++newStartIdx]
  }
}
if (oldStartIdx > oldEndIdx) {
  // æƒ…å†µ 6ï¸âƒ£
  refElm = isUndef(newCh[newEndIdx + 1]) ? null : newCh[newEndIdx + 1].elm
  addVnodes(...)
} else if (newStartIdx > newEndIdx) {
  // æƒ…å†µ 7ï¸âƒ£
  removeVnodes(...)
}
```

> å¦‚æœé—®ä¸ºä»€ä¹ˆè¿™ä¹ˆæ¯”è¾ƒï¼Œå›ç­”å°±æ˜¯ç»è¿‡å¾ˆå¤šäººå¾ˆå¤šå¹´çš„è®¨è®ºå¾—å‡ºçš„ï¼Œå…¶å®åªè¦è®°ä½è¿‡ç¨‹å°±è¡Œäº†ï¼Œå¦‚æœæƒ³è¦æ›´æ·±äº†è§£ Diff ç®—æ³•ï¼Œå¯ä»¥å» B ç«™çœ‹[ã€å°šç¡…è°·ã€‘Vueæºç è§£æä¹‹è™šæ‹ŸDOMå’Œdiffç®—æ³•](https://link.juejin.cn/?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1v5411H7gZ%3Fp%3D1%26vd_source%3D9f49d3e54ff277fa493d41e5e7bfa8dc)

## v-for ä¸­ä¸ºä»€ä¹ˆè¦åŠ  key

è¿™ä¸ªé—®é¢˜é¢è¯•å¾ˆå¸¸è§ï¼Œä½†æ˜¯å¯èƒ½å¤§éƒ¨åˆ†äººä¹Ÿå°±åªä¼šèƒŒå…«è‚¡ï¼Œæ²¡æœ‰å®Œå…¨ç†è§£ï¼Œé‚£ä¹ˆç»è¿‡ä»¥ä¸Šçš„ä»‹ç»ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°è‡ªå·±çš„ç†è§£ï¼š

- é¦–å…ˆï¼Œå¦‚æœä¸åŠ  key çš„è¯ï¼Œé‚£ä¹ˆå°±ä¸ä¼šå» Map é‡ŒåŒ¹é… *(O(1))*ï¼Œè€Œæ˜¯å¾ªç¯éå†æ•´ä¸ªåˆ—è¡¨ *(O(n))*ï¼Œè‚¯å®šåŠ  key è¦å¿«ä¸€ç‚¹ï¼Œæ€§èƒ½æ›´é«˜
- å…¶æ¬¡ï¼Œå¦‚æœä¸åŠ  key é‚£ä¹ˆåœ¨æ’å…¥æˆ–åˆ é™¤çš„æ—¶å€™å°±ä¼šå‡ºç°ï¼ŒåŸæœ¬ä¸æ˜¯åŒä¸€ä¸ªèŠ‚ç‚¹çš„å…ƒç´ è¢«è®¤ä¸ºæ˜¯ç›¸åŒèŠ‚ç‚¹ï¼Œä¸Šé¢ä¹Ÿæœ‰è¯´è¿‡æ˜¯ `sameVnode` å‡½æ•°åˆ¤æ–­çš„ï¼Œå› æ­¤å¯èƒ½ä¼šæœ‰é¢å¤– DOM æ“ä½œ

> ä¸ºä»€ä¹ˆè¯´å¯èƒ½æœ‰é¢å¤– DOM æ“ä½œå‘¢ï¼Ÿè¿™ä¸ªå’Œæ’å…¥çš„åœ°æ–¹æœ‰å…³ï¼Œä¹‹åä¼šè®¨è®ºï¼ŒåŒç†åˆ é™¤ä¹Ÿä¸€æ ·

## è¯æ˜ key çš„æ€§èƒ½

æˆ‘ä»¬åˆ†ä¸ºä¸‰ä¸ªå®éªŒï¼šæ²¡æœ‰ keyã€key ä¸º indexã€key å”¯ä¸€ï¼Œä»…è¯æ˜åŠ äº† key å¯ä»¥è¿›è¡Œæœ€å°åŒ–æ›´æ–°æ“ä½œã€‚

## å®éªŒä»£ç 

æœ‰å°ä¼™ä¼´è¯„è®ºè¯´å¯ä»¥æŠŠä»£ç è´´ä¸Šè¿™æ ·æ›´å¥½ï¼Œé‚£ä¹ˆä½œè€…å°±æŠŠä»£ç é™„ä¸Š ğŸ¥³ï¼š

```html
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
  <style>
    .box {
      display: flex;
      flex-direction: row;
    }
    .item {
      flex: 1;
    }
  </style>
</head>

<body>
  <div id="app">
    <div class="box">
      <div class="item">
        <h3>æ²¡æœ‰ key</h3>
        <p v-for="(item, index) in list">{{ item }}</p>
      </div>
      <div class="item">
        <h3>key ä¸º index</h3>
        <p v-for="(item, index) in list" :key="index">{{ item }}</p>
      </div>
      <div class="item">
        <h3>key å”¯ä¸€</h3>
        <p v-for="(item, index) in list" :key="item">{{ item }}</p>
      </div>
    </div>
    <button @click="click1">push(4)</button>
    <button @click="click2">splice(1, 0, 666)</button>
    <button @click="click3">unshift(999)</button>
    <br /><br />
    <button @click="click4">pop()</button>
    <button @click="click5">splice(1, 1)</button>
    <button @click="click6">shift()</button>
  </div>
  <script>
    var app = new Vue({
      el: '#app',
      data: {
        show: false,
        list: [1, 2, 3],
      },
      methods: {
        click1() {
          this.list.push(4);
        },
        click2() {
          this.list.splice(1, 0, 666);
        },
        click3() {
          this.list.unshift(999);
        },
        click4() {
          this.list.pop();
        },
        click5() {
          this.list.splice(1, 1);
        },
        click6() {
          this.list.shift();
        }
      },
    })
  </script>
</body>

</html>
```

### å¢åŠ å®éªŒ

å®éªŒå¦‚ä¸‹æ‰€ç¤ºï¼Œæˆ‘ä»¬é¦–å…ˆæ›´æ”¹åŸæ–‡å­—ï¼Œç„¶åç‚¹å‡»æŒ‰é’®**ã€Œè§‚å¯ŸèŠ‚ç‚¹å‘ç”Ÿå˜åŒ–çš„ä¸ªæ•°ã€**ï¼š

#### åœ¨é˜Ÿå°¾å¢åŠ 

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://photo-album-1314189846.cos.ap-shanghai.myqcloud.com/202304152331545.awebp)

#### åœ¨é˜Ÿå†…å¢åŠ 

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8f170afbd5ef4ae59047ff6fd5dda150~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp)

#### åœ¨é˜Ÿé¦–å¢åŠ 

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://photo-album-1314189846.cos.ap-shanghai.myqcloud.com/202304152332653.gif)

### åˆ é™¤å®éªŒ

#### åœ¨é˜Ÿå°¾åˆ é™¤

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://photo-album-1314189846.cos.ap-shanghai.myqcloud.com/202304152332779.awebp)

#### åœ¨é˜Ÿå†…åˆ é™¤

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://photo-album-1314189846.cos.ap-shanghai.myqcloud.com/202304152332455.awebp)

#### åœ¨é˜Ÿé¦–åˆ é™¤

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://photo-album-1314189846.cos.ap-shanghai.myqcloud.com/202304152332458.gif)

### å®éªŒç»“è®º

#### å¢åŠ å®éªŒ

è¡¨æ ¼ä¸ºæ¯æ¬¡å®éªŒä¸­ï¼Œæ¯ç§æƒ…å†µçš„æœ€å°æ›´æ–°é‡ï¼Œå‡è®¾åˆ—è¡¨åŸæ¥çš„é•¿åº¦ä¸º `n`

| å®éªŒ       | æ²¡æœ‰ key  | key ä¸º index | key å”¯ä¸€ |
| ---------- | --------- | ------------ | -------- |
| åœ¨é˜Ÿå°¾å¢åŠ  | 1         | 1            | 1        |
| åœ¨é˜Ÿä¸­å¢åŠ  | n - i + 1 | n - i + 1    | 1        |
| åœ¨é˜Ÿé¦–å¢åŠ  | n + 1     | n + 1        | 1        |

#### åˆ é™¤å®éªŒ

è¡¨æ ¼ä¸ºæ¯æ¬¡å®éªŒä¸­ï¼Œæ¯ç§æƒ…å†µçš„æœ€å°æ›´æ–°é‡ï¼Œå‡è®¾åˆ—è¡¨åŸæ¥çš„é•¿åº¦ä¸º `n`

| å®éªŒ       | æ²¡æœ‰ key | key ä¸º index | key å”¯ä¸€ |
| ---------- | -------- | ------------ | -------- |
| åœ¨é˜Ÿå°¾åˆ é™¤ | 1        | 1            | 1        |
| åœ¨é˜Ÿä¸­åˆ é™¤ | n - i    | n - i        | 1        |
| åœ¨é˜Ÿé¦–åˆ é™¤ | n        | n            | 1        |

é€šè¿‡ä»¥ä¸Šå®éªŒå’Œè¡¨æ ¼å¯ä»¥å¾—åˆ°åŠ ä¸Š key çš„æ€§èƒ½å’Œæœ€å°é‡æ›´æ–°çš„ä¸ªæ•°æ˜¯æœ€å°çš„ï¼Œè™½ç„¶åœ¨ `åœ¨é˜Ÿå°¾å¢åŠ ` å’Œ `åœ¨é˜Ÿå°¾åˆ é™¤` çš„æœ€å°æ›´æ–°é‡ç›¸åŒï¼Œä½†æ˜¯ä¹‹å‰ä¹Ÿè¯´äº†ï¼Œå¦‚æœæ²¡æœ‰ key æ˜¯è¦å¾ªç¯æ•´ä¸ªåˆ—è¡¨æŸ¥æ‰¾çš„ï¼Œæ—¶é—´å¤æ‚åº¦æ˜¯ O(n)ï¼Œè€ŒåŠ äº† key çš„æŸ¥æ‰¾æ—¶é—´å¤æ‚åº¦ä¸º O(1)ï¼Œå› æ­¤æ€»ä½“æ¥è¯´åŠ äº† key çš„æ€§èƒ½è¦æ›´å¥½ã€‚

## å†™åœ¨æœ€å

æœ¬æ–‡ä»æºç å’Œå®éªŒçš„è§’åº¦ä»‹ç»äº† Diff ç®—æ³•ï¼Œç›¸ä¿¡å¤§å®¶å¯¹ Diff ç®—æ³•æœ‰äº†æ›´æ·±çš„äº†è§£äº†ï¼Œå¦‚æœæœ‰é—®é¢˜å¯ç§ä¿¡äº¤æµæˆ–è€…è¯„è®ºåŒºäº¤æµï¼Œå¦‚æœå¤§å®¶å–œæ¬¢çš„è¯å¯ä»¥ç‚¹èµ â• æ”¶è— ğŸŒŸ

## æºç å‡½æ•°é™„å½•

> åˆ—ä¸¾ä¸€äº›æºç ä¸­å‡ºç°çš„ç®€å•å‡½æ•°


`setTextContent`
```
function setTextContent(node: Node, text: string) {
  node.textContent = text
}
```
`isUndef`
```
function isUndef(v: any): v is undefined | null {
  return v === undefined || v === null
}
```
`isDef`
```
function isDef<T>(v: T): v is NonNullable<T> {
  return v !== undefined && v !== null
}
```
`insertBefore`
```
function insertBefore(
  parentNode: Node,
  newNode: Node,
  referenceNode: Node
) {
  parentNode.insertBefore(newNode, referenceNode)
}
```
`nextSibling`
```
function nextSibling(node: Node) {
  return node.nextSibling
}
```
`createKeyToOldIdx`

```
function createKeyToOldIdx(children, beginIdx, endIdx) {
  let i, key
  const map = {}
  for (i = beginIdx; i <= endIdx; ++i) {
    key = children[i].key
    if (isDef(key)) map[key] = i
  }
  return map
}
```

